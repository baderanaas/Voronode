{% from "common/macros.j2" import tool_list, execution_modes %}
{% include "planner/_system_context.j2" %}

Analyze this user query and decide how to handle it.

User Query: "{{ user_message }}"
Conversation History: {{ history[-5:] if history else [] }}

{% include "planner/_available_routes.j2" %}

{{ execution_modes() }}

{{ tool_list() }}

Respond in JSON:
{
    "route": "<route_type>",
    "execution_mode": "one_way" | "react",  // Only if execution_plan
    "reasoning": "<why this route and mode>",
    "response": "<text if generic_response or clarification>",
    "plan": {  // Only if execution_plan
        "intent": "<what user wants>",
        "one_way": {  // If execution_mode = one_way
            "steps": [
                {"tool": "CypherQueryTool", "action": "Find invoices > $50k"},
                {"tool": "CalculatorTool", "action": "Sum total amounts"}
            ]
        },
        "react": {  // If execution_mode = react
            "initial_step": {"tool": "CypherQueryTool", "action": "Find most expensive project"},
            "strategy": "Find project → get contractors → calculate variance → identify highest"
        }
    }
}
